{% extends 'base.html' %}
{% include 'header.html' %}

{% block body %}



<div class="modal fade" id="levelModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body d-flex flex-column align-items-center justify-content-center">
                <a class="navbar-brand mt-3 mb-3" href="#">
                    <img src="../static/letter-r.png" alt="Logo" width="50" height="50">
                </a>
                <h1 class="modal-title fs-2 fw-bold mb-2" id="exampleModalLabel">RetrieWordle</h1>
                <h1 class="modal-title fs-2 fw-lighter mb-5" id="exampleModalLabel">Guess the 5-letter word.</h1>
                <div class="input-group input-group-lg gap-1 mb-3">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="floatingInput" placeholder="John Doe">
                        <label for="floatingInput">Username</label>
                    </div>
                </div>
                <div class="btn-group btn-group-lg gap-1 mb-3" role="group"
                    aria-label="Vertical radio toggle button group">
                    <input type="radio" class="btn-check" name="vbtn-radio" id="vbtn-radio1" autocomplete="off" checked>
                    <label class="btn btn-outline-success" for="vbtn-radio1">Easy</label>
                    <input type="radio" class="btn-check" name="vbtn-radio" id="vbtn-radio2" autocomplete="off">
                    <label class="btn btn-outline-warning" for="vbtn-radio2">Medium</label>
                    <input type="radio" class="btn-check" name="vbtn-radio" id="vbtn-radio3" autocomplete="off">
                    <label class="btn btn-outline-danger" for="vbtn-radio3">Hard</label>
                </div>
                <button type="submit" class="btn btn-lg btn-primary" id="playButton">Play</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="questionModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"">
      <div class=" modal-content">
        <div class="modal-header">
            <h1 class="modal-title fs-3" id="exampleModalLabel">How To Play</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <h5>Guess the Wordle in 6 tries.</h5>
            <ul>
                <li>Each guess must be a valid 5-letter word.</li>
                <li>The color of the tiles will change to show how close your guess was to the word.</li>
            </ul>
            <h6>Examples</h6>
            <p>W is in the word and in the correct spot.</p>
            <p>I is in the word but in the wrong spot.</p>
            <p>U is not in the word in any spot.</p>
        </div>
    </div>
</div>
</div>

<div class="modal fade" id="leaderboardModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"">
      <div class=" modal-content">
        <div class="modal-header">
            <h1 class="modal-title fs-3" id="exampleModalLabel">Leaderboard</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

        </div>
    </div>
</div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"">
      <div class=" modal-content">
        <div class="modal-header">
            <h1 class="modal-title fs-3" id="exampleModalLabel">Settings</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

        </div>
    </div>
</div>
</div>

<div class="d-flex justify-content-center">
    <form action="">
        {% for i in range(6) %}
        <div class="row" id="row-{{ i }}">
            {% for j in range(5) %}
            <div class="col p-1">
                <input type="text" maxlength="1"
                    class="form-control shadow-none text-uppercase text-center bg-dark square-input letter-button"
                    id="letter-{{ i }}-{{ j }}" placeholder="" disabled readonly>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </form>
</div>

<div class="d-flex flex-column justify-content-center align-items-center mt-4">
    <div class="p-1 keyboard-letters">
        <button type="button" class="btn btn-secondary letter-button" id="Q">Q</button>
        <button type="button" class="btn btn-secondary letter-button" id="W">W</button>
        <button type="button" class="btn btn-secondary letter-button" id="E">E</button>
        <button type="button" class="btn btn-secondary letter-button" id="R">R</button>
        <button type="button" class="btn btn-secondary letter-button" id="T">T</button>
        <button type="button" class="btn btn-secondary letter-button" id="Y">Y</button>
        <button type="button" class="btn btn-secondary letter-button" id="U">U</button>
        <button type="button" class="btn btn-secondary letter-button" id="I">I</button>
        <button type="button" class="btn btn-secondary letter-button" id="O">O</button>
        <button type="button" class="btn btn-secondary letter-button" id="P">P</button>
    </div>
    <div class="p-1 keyboard-letters">
        <button type="button" class="btn btn-secondary letter-button" id="A">A</button>
        <button type="button" class="btn btn-secondary letter-button" id="S">S</button>
        <button type="button" class="btn btn-secondary letter-button" id="D">D</button>
        <button type="button" class="btn btn-secondary letter-button" id="F">F</button>
        <button type="button" class="btn btn-secondary letter-button" id="G">G</button>
        <button type="button" class="btn btn-secondary letter-button" id="H">H</button>
        <button type="button" class="btn btn-secondary letter-button" id="J">J</button>
        <button type="button" class="btn btn-secondary letter-button" id="K">K</button>
        <button type="button" class="btn btn-secondary letter-button" id="L">L</button>
    </div>
    <div class="p-1 keyboard-letters">
        <button type="button" class="btn btn-secondary special-key letter-button" id="enter">ENTER</button>
        <button type="button" class="btn btn-secondary letter-button" id="Z">Z</button>
        <button type="button" class="btn btn-secondary letter-button" id="X">X</button>
        <button type="button" class="btn btn-secondary letter-button" id="C">C</button>
        <button type="button" class="btn btn-secondary letter-button" id="V">V</button>
        <button type="button" class="btn btn-secondary letter-button" id="B">B</button>
        <button type="button" class="btn btn-secondary letter-button" id="N">N</button>
        <button type="button" class="btn btn-secondary letter-button" id="M">M</button>
        <button type="button" class="btn btn-secondary special-key backspace letter-button" id="backspace">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.25"
                stroke="currentColor" class="">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 9.75 14.25 12m0 0 2.25 2.25M14.25 12l2.25-2.25M14.25 12 12 14.25m-2.58 4.92-6.374-6.375a1.125 1.125 0 0 1 0-1.59L9.42 4.83c.21-.211.497-.33.795-.33H19.5a2.25 2.25 0 0 1 2.25 2.25v10.5a2.25 2.25 0 0 1-2.25 2.25h-9.284c-.298 0-.585-.119-.795-.33Z" />
            </svg>
        </button>
    </div>
</div>

<script>
    var isModalOpen = false; // Set to false initially
    $(document).ready(function () {
        $('#levelModal').modal('show');

        // When the modal is shown, set isModalOpen to true
        $('#levelModal').on('shown.bs.modal', function () {
            isModalOpen = true;
        });

        // When the modal is hidden, set isModalOpen to false
        $('#levelModal').on('hidden.bs.modal', function () {
            isModalOpen = false;
        });

        $('#levelForm').on('submit', function (event) {
            event.preventDefault();
            $.ajax({
                url: '/save_username',  // the endpoint
                type: 'POST',  // http method
                data: $(this).serialize(),  // data sent with the post request
                success: function (response) {
                    // handle the response from the server
                },
                error: function (error) {
                    // handle errors
                }
            });
        });

        $('#levelModal').on('hidden.bs.modal', function () {
            $('#questionModal').modal('show');
        });
    });

    // Setup
    let guessableWords;
    let answerWords;
    let randomAnswer;

    async function loadWords() {
        // Fetch the guessable words
        let response = await fetch('/guessable_words');
        let data = await response.json();
        guessableWords = data;
        console.log('Guessable words:', guessableWords);

        // Fetch the answer words
        response = await fetch('/answer_words');
        data = await response.json();
        answerWords = data;
        console.log('Answer words:', answerWords);

        // Choose a random answer
        let randomIndex = Math.floor(Math.random() * answerWords.length);
        randomAnswer = answerWords[randomIndex];
        console.log('Chosen Answer:', randomAnswer);
    }

    // fetches the words from word.db, places them into the guessableWords and answerWords arrays, and chooses a random answer
    loadWords();

    const numGuesses = 6;
    const numLetters = 5;
    let guesses = [];
    let currGuess = 0;
    let finalSubmit = false; // A variable to check when the player has submitted their last guess
    for (let i = 0; i < numGuesses; i++) {
        guesses.push("");
    }

    function keyboardHandler(input) {
        // Check if the key is "Enter" or "Backspace"
        if (isModalOpen) {
            return;
        } else {
            if (input.key === "Enter") {
                if (currGuess < numGuesses - 1) {
                    if (guesses[currGuess].length === numLetters && guessableWords.includes(guesses[currGuess])) {
                        if (guesses[currGuess].toLowerCase() == randomAnswer.toLowerCase()) {
                            console.log("Correct guess! The word was:", randomAnswer);
                            finalSubmit = true;
                            updateColors();
                        } else {
                            console.log("It's a valid word, but not the correct answer.");
                            updateColors();
                            currGuess++;
                        }
                    } else {
                        console.log("Invalid guess. Please enter a valid 5-letter word.");
                    }
                } else { // This block of code runs whenever the user is on their last guess
                    if (guesses[currGuess].length === numLetters && guessableWords.includes(guesses[currGuess])) {
                        if (guesses[currGuess].toLowerCase() == randomAnswer.toLowerCase()) {
                            console.log("Correct guess! The word was:", randomAnswer);
                            finalSubmit = true; // Set finalSubmit to true when the player has submitted their last guess
                            updateColors();
                        } else {
                            console.log("It's a valid word, but not the correct answer. User has submitted their last guess.");
                            finalSubmit = true;
                            updateColors();
                        }
                    } else {
                        console.log("Invalid guess. Please enter a valid 5-letter word.");
                    }
                }
            } else if (input.key === "Backspace") {
                if (currGuess < numGuesses - 1 || !finalSubmit) { // Checks if the player has submitted their last guess
                    guesses[currGuess] = guesses[currGuess].slice(0, -1); // If not, remove the last letter from the current guess
                }
                updateLetters();
            } else {
                // Check if the key is a letter from A to Z
                if (!input.key.match(/^[a-z]$/i)) {
                    // It's not a letter, ignore it
                    return;
                }
                inputLetter(input.key.toLowerCase());
            }
        }
    }

    function buttonHandler(event) {
        let button = event.currentTarget;

        // Check if the button is the "ENTER" button
        if (button.textContent === "ENTER") {
            // Handle the "ENTER" button
            if (currGuess < numGuesses - 1) {
                if (guesses[currGuess].length === numLetters && guessableWords.includes(guesses[currGuess])) {
                    if (guesses[currGuess].toLowerCase() == randomAnswer.toLowerCase()) {
                        console.log("Correct guess! The word was:", randomAnswer);
                        finalSubmit = true;
                        updateColors();
                    } else {
                        console.log("It's a valid word, but not the correct answer.");
                        updateColors();
                        currGuess++;
                    }
                } else {
                    console.log("Invalid guess. Please enter a valid 5-letter word.");
                }
            } else {
                if (guesses[currGuess].length === numLetters && guessableWords.includes(guesses[currGuess])) {
                    if (guesses[currGuess].toLowerCase() == randomAnswer.toLowerCase()) {
                        console.log("Correct guess! The word was:", randomAnswer);
                        finalSubmit = true; // Set finalSubmit to true when the player has submitted their last guess
                        updateColors();
                    } else {
                        console.log("It's a valid word, but not the correct answer.");
                        finalSubmit = true;
                        updateColors();
                    }
                } else {
                    console.log("Invalid guess. Please enter a valid 5-letter word.");
                }
            }
        } else if (button.classList.contains("backspace")) {
            // Handle the "BACKSPACE" button
            if (currGuess < numGuesses - 1 || !finalSubmit) {
                guesses[currGuess] = guesses[currGuess].slice(0, -1);
            }
            updateLetters();
        } else {
            // Handle other buttons
            inputLetter(button.textContent.toLowerCase());
        }
    }

    function inputLetter(key) {
        if (guesses[currGuess].length < numLetters) {
            guesses[currGuess] += key;
            updateLetters();
        }
    }

    function updateLetters() {
        let lettersGuessed = currGuess * numLetters + guesses[currGuess].length;
        let letterBoxes = document.getElementsByClassName("square-input");
        for (let i = 0; i < numGuesses; i++) {
            for (let j = 0; j < numLetters; j++) {
                if (i * numLetters + j < lettersGuessed) {
                    letterBoxes[i * numLetters + j].placeholder = guesses[i][j];
                }
                else {
                    //There's probably a better way to remove backspaced letters but this works for now
                    letterBoxes[i * numLetters + j].placeholder = "";
                }
            }
        }
    }

    // Helper function to be used in updateColors()
    // Accounts for duplicates in the guess and answer correctly(?)
    // I don't see any issues after doing some testing so far lol
    function determineColor(guess, j) {
        var answer = randomAnswer.toLowerCase();
        var letter = guess[j];
        if (letter === answer[j]) {
            return "bg-success"; // Green
        } else if (answer.includes(letter)) { // Additional logic to account for duplicates
            var nTarget = answer.split(letter).length - 1;
            var nCorrect = 0; 
            var nOccurrence = 0;

            for (var i = 0; i < numLetters; i++) {
                if (guess[i] === letter) {
                    if (i <= j) {
                        nOccurrence++;
                    } else if (letter === answer[i]) {
                        nCorrect++;
                    }
                }
            }
            if (nTarget - nCorrect - nOccurrence >= 0) {
                return "bg-warning"; // Yellow
            }
        }
        return "bg-danger"; // Grey
    }

    function updateColors() {
        var guess = guesses[currGuess].toLowerCase();
        var answer = randomAnswer.toLowerCase();

        // Colors the Wordle tiles based on the correctness of the guess
        for (var i = 0; i < numLetters; i++) {
            var color = determineColor(guess, i);
            var letterBox = document.getElementById("letter-" + currGuess + "-" + i);
            letterBox.classList.remove("bg-dark", "bg-success", "bg-warning", "bg-danger");
            letterBox.classList.add(color);
        }

        // Colors the keyboard buttons based on the correctness of the guess
        var buttons = document.getElementsByClassName('letter-button');
        for (var i = 0; i < buttons.length; i++) {
            var button = buttons[i];
            var letter = button.id.toLowerCase();

            if (letter !== "enter" && letter !== "backspace" && guess.includes(letter)) {
                if (button.classList.contains("btn-success")) {
                    continue;
                } else {
                    var color = determineColor(guess, guess.indexOf(letter));
                    button.classList.remove("btn-secondary", "btn-warning", "btn-danger");
                    button.classList.add(color.replace("bg-", "btn-"));
                }
            }
        }
    }

    function testFunc(event) {
        //console.log("button pressed");
        console.log(event.currentTarget.textContent);
    }

    addEventListener("keydown", keyboardHandler);
    //addEventListener("keydown", updateLetters);

    let letterButtons = document.getElementsByClassName("letter-button");
    //letterButtons.onclick = testFunc;
    for (let i = 0; i < letterButtons.length; i++) {
        //letterButtons[i].onclick = testFunc;
        letterButtons[i].addEventListener("click", buttonHandler);
    }
</script>

{% include "footer.html" %}
{% endblock %}
